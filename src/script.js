/* Josh Channin
   Fake data from generatedata.com
*/
var data = [
    {
      type: "visa",
      number: "**** **** **** 2562",
      month: "12",
      year: "17",
      id: 1,
      transactions: [
        {
          title: "Apple Iphone 6, 6g GB",
          vendor: "Electronics #343223",
          date: "12 July, 2015",
          amount: "650.00",
          currency: "$",
          action: "debit"
        },
        {
          title: "Funds Added",
          vendor: "Payment #343212",
          date: "11 July, 2015",
          amount: "900.00",
          currency: "$",
          action: "credit"
        },
        {
          title: "Energy Bill",
          vendor: "#343566",
          date: "11 July, 2015",
          amount: "84.96",
          currency: "$",
          action: "debit"
        },
        {
          title: "Mega Image SRL",
          vendor: "Food&Health #34365",
          date: "11 July, 2015",
          amount: "112.75",
          currency: "$",
          action: "debit"
        },
        {
          title: "ATM DV24",
          vendor: "#343253",
          date: "09 July, 2015",
          amount: "200.00",
          currency: "$",
          action: "debit"
        },
        {
          title: "Lukoil Station",
          vendor: "Gas #343279",
          date: "09 July, 2015",
          amount: "190.00",
          currency: "$",
          action: "debit"
        }
      ]
    },
    {
      type: "amex",
      number: "**** ****** 14525",
      month: "07",
      year: "19",
      id: 2,
      transactions: [
        {
          title: "Sales and Marketing",
          vendor: "Borland",
          date: "23 Nov, 2016",
          amount: "65.76",
          currency: "$",
          action: "debit"
        },
        {
          title: "Tech Support",
          vendor: "Microsoft",
          date: "1 Aug, 2017",
          amount: "64.62",
          currency: "$",
          action: "debit"
        },
        {
          title: "Media Relations",
          vendor: "Chami",
          date: "8 Jun, 2017",
          amount: "98.82",
          currency: "$",
          action: "debit"
        },
        {
          title: "Accounting",
          vendor: "Chami",
          date: "21 Jan, 2017",
          amount: "7889.84",
          currency: "$",
          action: "credit"
        },
        {
          title: "Sales and Marketing",
          vendor: "Lavasoft",
          date: "24 Jul, 2017",
          amount: "77.68",
          currency: "$",
          action: "debit"
        },
        {
          title: "Asset Management",
          vendor: "Cakewalk",
          date: "11 Oct, 2016",
          amount: "52.40",
          currency: "$",
          action: "credit"
        },
        {
          title: "Finances",
          vendor: "Sibelius",
          date: "19 Aug, 2016",
          amount: "32.20",
          currency: "$",
          action: "debit"
        },
        {
          title: "Sales and Marketing",
          vendor: "Chami",
          date: "4 Jun, 2017",
          amount: "72.62",
          currency: "$",
          action: "debit"
        },
        {
          title: "Customer Relations",
          vendor: "Finale",
          date: "22 Aug, 2017",
          amount: "77.77",
          currency: "$",
          action: "debit"
        },
        {
          title: "Sales and Marketing",
          vendor: "Apple Systems",
          date: "19 May, 2017",
          amount: "84.50",
          currency: "$",
          action: "credit"
        },
        {
          title: "Quality Assurance",
          vendor: "Cakewalk",
          date: "29 Jul, 2017",
          amount: "80.03",
          currency: "$",
          action: "debit"
        },
        {
          title: "Public Relations",
          vendor: "Altavista",
          date: "10 Oct, 2017",
          amount: "6.60",
          currency: "$",
          action: "credit"
        }
      ]
    },
    {
      type: "mc",
      number: "**** **** **** 8866",
      month: "02",
      year: "22",
      id: 3,
      transactions: [
        {
          title: "Borland",
          vendor: "Cursus Diam PC",
          date: "30 Apr, 2017",
          amount: "9647.17",
          currency: "$",
          action: "debit"
        },
        {
          title: "Sibelius",
          vendor: "Ridiculus Corporation",
          date: "17 Apr, 2017",
          amount: "1058.02",
          currency: "$",
          action: "credit"
        },
        {
          title: "Altavista",
          vendor: "Molestie Orci Tincidunt Company",
          date: "9 Mar, 2018",
          amount: "6622.94",
          currency: "$",
          action: "credit"
        },
        {
          title: "Sibelius",
          vendor: "Eu Industries",
          date: "20 Mar, 2017",
          amount: "2649.70",
          currency: "$",
          action: "credit"
        },
        {
          title: "Yahoo",
          vendor: "Mollis Nec Cursus Associates",
          date: "20 Sep, 2016",
          amount: "9343.63",
          currency: "$",
          action: "credit"
        },
        {
          title: "Sibelius",
          vendor: "Eget Metus Eu Incorporated",
          date: "27 Jun, 2016",
          amount: "6516.49",
          currency: "$",
          action: "credit"
        },
        {
          title: "Google",
          vendor: "Tempus Company",
          date: "26 May, 2017",
          amount: "8504.32",
          currency: "$",
          action: "debit"
        },
        {
          title: "Chami",
          vendor: "Id Ante Incorporated",
          date: "13 Aug, 2017",
          amount: "3592.96",
          currency: "$",
          action: "credit"
        },
        {
          title: "Finale",
          vendor: "Iaculis Quis Incorporated",
          date: "2 Jan, 2017",
          amount: "8743.26",
          currency: "$",
          action: "debit"
        },
        {
          title: "Chami",
          vendor: "Eu Nulla At Institute",
          date: "5 Sep, 2017",
          amount: "3112.89",
          currency: "$",
          action: "credit"
        },
        {
          title: "Adobe",
          vendor: "Arcu Nunc Inc.",
          date: "22 Aug, 2017",
          amount: "2239.85",
          currency: "$",
          action: "credit"
        },
        {
          title: "Macromedia",
          vendor: "Eros LLP",
          date: "17 Feb, 2018",
          amount: "3641.58",
          currency: "$",
          action: "debit"
        },
        {
          title: "Macromedia",
          vendor: "Diam Dictum Associates",
          date: "24 Dec, 2016",
          amount: "3592.79",
          currency: "$",
          action: "credit"
        },
        {
          title: "Yahoo",
          vendor: "Eget Odio Aliquam Corporation",
          date: "30 Oct, 2016",
          amount: "9453.17",
          currency: "$",
          action: "credit"
        },
        {
          title: "Sibelius",
          vendor: "Eros Non Enim Company",
          date: "15 Feb, 2018",
          amount: "5283.54",
          currency: "$",
          action: "debit"
        }
      ]
    }
  ];
  
  // vars
  var balance = 0;
  
  // append cc to modal
  var ccModalAppend = function (ccType, ccNum, month, year) {
    if (ccType == "amex") {
      $(".cc-select").prepend(
        '<div class="cc ' +
          ccType +
          ' cc-active">\
            <div class="cc-img-main"></div>\
            <div class="cc-num">**** *******  ' +
          ccNum +
          '</div>\
            <div class="cc-date">Valid Thru: ' +
          month +
          "/" +
          year +
          "</div>\
            </div>"
      );
    } else {
      $(".cc-select").prepend(
        '<div class="cc ' +
          ccType +
          ' cc-active">\
            <div class="cc-img-main"></div>\
            <div class="cc-num">**** **** **** ' +
          ccNum +
          '</div>\
            <div class="cc-date">Valid Thru: ' +
          month +
          "/" +
          year +
          "</div>\
            </div>"
      );
    }
  };
  
  // append credit cards
  var ccAppend = function (data) {
    $(".cc-select").append(
      '<div id="' +
        data.id +
        '" class="cc ' +
        data.type +
        '">\
        <div class="cc-img-main"></div>\
        <div class="cc-num">' +
        data.number +
        '</div>\
        <div class="cc-date">Valid Thru: ' +
        data.month +
        "/" +
        data.year +
        "</div>\
        </div>"
    );
  };
  
  // load trams data
  var load = function (id, data) {
    clearTrans();
    balance = 0;
    data.forEach(function (e) {
      if (e.id == id) {
        startAppend(e);
      }
    });
    balanceCalc(balance);
    noTrans();
  };
  
  // count valid cc numbers
  var countValid = function (ccType) {
    if (ccType == "amex") {
      if ($("#ccnum").val().length != 15) {
        $("#ccnum").removeClass("valid-green");
        $("#ccnum").addClass("valid-red");
        return false;
      } else {
        $("#ccnum").addClass("valid-green");
        $("#ccnum").removeClass("valid-red");
        return true;
      }
    } else {
      if ($("#ccnum").val().length != 16) {
        $("#ccnum").addClass("valid-red");
        $("#ccnum").removeClass("valid-green");
        return false;
      } else {
        $("#ccnum").addClass("valid-green");
        $("#ccnum").removeClass("valid-red");
        return true;
      }
    }
  };
  
  // append trans data
  var startAppend = function (e) {
    for (var i = 0; i < e.transactions.length; i++) {
      if (e.transactions[i].action == "credit") {
        var action = "trans-plus";
        var color = "green";
        balance = balance + parseFloat(e.transactions[i].amount, 10);
      } else {
        var action = "trans-minus";
        var color = "blue";
        balance = balance - parseFloat(e.transactions[i].amount, 10);
      }
      $(".trans-list")
        .append(
          ' <div class="trans trans-' +
            e.type +
            '">\
            <div class="trans-details">\
            <span class="' +
            action +
            '"></span>\
            <h3 class="trans-name">' +
            e.transactions[i].title +
            '</h3>\
            <h5 class="trans-type-date">' +
            e.transactions[i].vendor +
            " - " +
            e.transactions[i].date +
            '</h5>\
            </div>\
            <div class="trans-amt">\
            <h4 class="trans-amt amt-' +
            color +
            '">' +
            e.transactions[i].currency +
            " " +
            e.transactions[i].amount +
            "</h4>\
            </div>\
            </div>"
        )
        .show("fast");
      noTrans();
    }
  };
  
  // calc balance and format
  var balanceCalc = function balanceCalc(balance) {
    return balance < 0
      ? $("#balance").html("$(" + Math.abs(balance).toLocaleString() + ")")
      : $("#balance").html("$" + balance.toLocaleString() + "");
  };
  
  // clear trans list
  var clearTrans = function () {
    $(".trans-list").empty().hide();
  };
  
  // clear modal
  var clearModal = function () {
    $(".cc-img").removeClass("cc-md-active");
    $("#ccnum, #year, #month").val("");
    $("#ccnum").css("border", "1px solid #e1e1e1;");
    $("#ccnum").removeClass("valid-red").removeClass("valid-green");
  };
  
  // no trans
  var noTrans = function () {
    $(".trans-list").children().length == 0
      ? $(".trans-list")
          .append('<h5 class="no-trans"> No transactions for this card</h5>')
          .show("fast")
      : "";
  };
  
  // load inital data
  $(document).ready(function () {
    data.forEach(function (e) {
      ccAppend(e);
    });
    $(".cc:eq(0)").addClass("cc-active");
    load($(".cc-active").attr("id"), data);
  });
  
  // click listener for active card
  $(document).on("click", ".cc", function (e) {
    $(".cc").removeClass("cc-active");
    $(this).addClass("cc-active");
    load($(".cc-active").attr("id"), data);
  });
  
  // click listener for active card in modal selector
  $(document).on("click", ".cc-img", function (e) {
    $(".cc-img").removeClass("cc-md-active");
    $(this).addClass("cc-md-active");
    $(".md-cc > .cc-md-active").attr("class").split(" ")[1] == "amex"
      ? $("#ccnum").attr("placeholder", "**** ****** *****")
      : $("#ccnum").attr("placeholder", "**** **** **** ****");
    $("#ccnum, #year, #month").removeAttr("disabled");
  });
  
  // close modal
  $(document).on("click", ".modal-close", function (e) {
    $(".modal").hide();
    clearModal();
  });
  
  // open modal
  $(".modal-open").on("click", function (e) {
    $(".modal").show();
  });
  
  // add new card logic
  // TODO: Add numbous checks, sanitize, error catching
  $(document).on("click", ".modal-add-cc", function (e) {
    var ccType = null;
    if ($(".md-cc > .cc-md-active").attr("class")) {
      ccType = $(".md-cc > .cc-md-active").attr("class").split(" ")[1];
    }
    var ccNum = $("#ccnum")
      .val()
      .substr($("#ccnum").val().length - 4);
    var month = $("#month").val();
    var year = $("#year").val();
  
    if (ccNum && month && year && ccType) {
      $(".modal").hide();
      $(".cc").removeClass("cc-active");
  
      ccModalAppend(ccType, ccNum, month, year);
      var p = data[data.length - 1].id + 1;
      data.push({
        type: ccType,
        number:
          ccType == "amex" ? "**** ****** " + ccNum : "**** **** **** " + ccNum,
        month: month,
        year: year,
        id: p,
        transactions: []
      });
      clearTrans();
      clearModal();
      load(ccType, data);
    } else {
      alert("Sorry, missing required fields"); // will do for now
    }
  });
  
  // keypress cc count
  $("#ccnum").on("keyup", function () {
    var ccType = $(".md-cc > .cc-md-active").attr("class").split(" ")[1];
    countValid(ccType);
  });
  